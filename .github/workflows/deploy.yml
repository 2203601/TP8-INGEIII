name: CI/CD CoffeeHub

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  packages: write

jobs:
  # ===============================
  # 1) BUILD & PUSH GHCR
  # ===============================
  build-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Log in to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_PAT }}

    # ---------- Fix nombre de repo en minúsculas ----------
    - name: Set lowercase repo name
      id: repo
      run: echo "repo_lowercase=${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT

    # ---------- Backend ----------
    - name: Build Backend image
      run: |
        docker build -t ghcr.io/${{ steps.repo.outputs.repo_lowercase }}/backend:latest coffehub/backend

    - name: Push Backend image
      run: docker push ghcr.io/${{ steps.repo.outputs.repo_lowercase }}/backend:latest

    # ---------- Frontend ----------
    - name: Build Frontend image
      run: |
        docker build -t ghcr.io/${{ steps.repo.outputs.repo_lowercase }}/frontend:latest coffehub/frontend

    - name: Push Frontend image
      run: docker push ghcr.io/${{ steps.repo.outputs.repo_lowercase }}/frontend:latest

  # ===============================
  # 2) DEPLOY QA (automático)
  # ===============================
  deploy-qa:
    needs: build-push
    runs-on: ubuntu-latest

    steps:
    - name: Deploy Backend QA
      run: |
        curl -X POST "https://api.render.com/v1/services/${{ secrets.RENDER_BACKEND_QA_ID }}/deploys" \
        -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}"

    - name: Deploy Frontend QA
      run: |
        curl -X POST "https://api.render.com/v1/services/${{ secrets.RENDER_FRONTEND_QA_ID }}/deploys" \
        -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}"

  # ===============================
  # 3) DEPLOY PROD (Manual)
  # ===============================
  deploy-prod:
    needs: deploy-qa
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://coffehub-frontend-prod.onrender.com

    steps:
    - name: Deploy Backend PROD
      run: |
        curl -X POST "https://api.render.com/v1/services/${{ secrets.RENDER_BACKEND_PROD_ID }}/deploys" \
        -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}"

    - name: Deploy Frontend PROD
      run: |
        curl -X POST "https://api.render.com/v1/services/${{ secrets.RENDER_FRONTEND_PROD_ID }}/deploys" \
        -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}"
